<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>CCM3 - Logs</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/dt-1.10.13/r-2.1.0/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.45/css/bootstrap-datetimepicker.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.4/css/selectize.bootstrap3.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap-combobox.css"/>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">CCM 3 Viewer</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="index.html">Repositories</a></li>
                <li><a href="#" class="active">Log</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12 main">
            <ul class="breadcrumb page-header">
                <li>Logs</li>
            </ul>
            <div class="row bottom-margin">
                <div class="col-sm-12">
                    <div class="row extra-bottom-padding">
                        <div class="col-sm-2">Action</div>
                        <div class="col-sm-2">
                            <select id="action" placeholder="Select an action...">
                                <option value="">Type an action...</option>
                            </select>
                        </div>
                        <div class="col-sm-2">Stage</div>
                        <div class="col-sm-2">
                            <select id="stage" placeholder="Select a Stage...">
                                <option value="">Type a Stage...</option>
                            </select>
                        </div>
                    </div><!-- /.row -->
                    <div class="row extra-bottom-padding">
                        <div class="col-sm-2">Repository Name</div>
                        <div class="col-sm-2">
                            <input type="text" id="repositoryName" class="form-control"/>
                        </div>
                        <div class="col-sm-2">Repository Group Name</div>
                        <div class="col-sm-2">
                            <input type="text" id="repositoryGroupName" class="form-control"/>
                        </div>
                    </div><!-- /.row -->
                    <div class="row extra-bottom-padding">
                        <div class="col-sm-2">Branch</div>
                        <div class="col-sm-2">
                            <input type="text" id="branch" class="form-control"/>
                        </div>
                        <div class="col-sm-2">Version</div>
                        <div class="col-sm-2">
                            <input type="text" id="version" class="form-control"/>
                        </div>
                    </div><!-- /.row -->
                    <div class="row extra-bottom-padding">
                        <div class="col-sm-2">User</div>
                        <div class="col-sm-2">
                            <input type="text" id="user" class="form-control"/>
                        </div>
                        <div class="col-sm-2">AuftragNr</div>
                        <div class="col-sm-2">
                            <input type="text" id="auftrag" class="form-control"/>
                        </div>
                    </div><!-- /.row -->
                    <div class="row extra-bottom-padding">
                        <div class="col-sm-2">From</div>
                        <div class="col-sm-2">
                            <div class="input-group date datepicker">
                                <input type="text" class="form-control" id="lowerDate"><span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                            </div>
                        </div>
                        <div class="col-sm-2">To</div>
                        <div class="col-sm-2">
                            <div class="input-group date datepicker">
                                <input type="text" class="form-control" id="upperDate"><span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                            </div>
                        </div>
                    </div><!-- /.row -->

                    <div class="row">
                        <div class="col-sm-6"></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-2"></div>
                        <div class="col-sm-2">
                            <button type="button" class="btn btn-default" id="searchButton">
                                <span class="glyphicon glyphicon-search"></span> Search
                            </button>
                            <button type="button" class="btn btn-default" id="clearButton">
                                <span class="glyphicon glyphicon-remove"></span> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <hr/>
            <div class="table-responsive">
                <table class="table table-striped table-full-width" id="resulttable">
                    <thead>
                    <tr>
                        <th>Action</th>
                        <th>Stage</th>
                        <th>Repository Name</th>
                        <th>Repository Group Name</th>
                        <th>Branch</th>
                        <th>Version</th>
                        <th>User</th>
                        <th>Auftrag</th>
                        <th>Datum</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/vendor/jquery.min.js"><\/script>')
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script type="text/javascript">
    var datatable;
    $(document).ready(function() {
        $('#action').focus();
        bindevent();
        initDropdowns();
        datatable = $('#resulttable').DataTable({
            "processing": true,
            "serverSide": true,
            "searching": false,
            "ajax": "api/v1/logs",
            "order": [[ 8, 'desc' ]],
            "columns": [
                {"data": "action"},
                {"data": "stage"},
                {"data": "repositoryName"},
                {"data": "repositoryGroupName"},
                {"data": "branch"},
                {"data": "version"},
                {"data": "userId"},
                {"data": "auftragNr"},
                {"data": "logdate"}
            ],
            "columnDefs": [{
                targets: 8,
                render: $.fn.dataTable.render.moment('YYYY-MM-DDTHH:mm:ss','DD.MM.YYYY HH:mm')
            }]
        });
        $('.datepicker').datetimepicker({format: 'DD.MM.YYYY HH:mm'});
    });

    function searchLogs(event){
        var action = $("#action").val();
        var stage = $("#stage").val();
        var repositoryName = $("#repositoryName").val();
        var repositoryGroupName = $("#repositoryGroupName").val();
        var branch = $("#branch").val();
        var version = $("#version").val();
        var user = $("#user").val();
        var auftrag = $("#auftrag").val();
        var lowerDate = $("#lowerDate").val();
        var upperDate = $("#upperDate").val();

        var query = '?1=1';
        if (action) {
            query += "&action=" + action;
        }
        if (stage) {
            query += "&stage=" + stage;
        }
        if (repositoryName) {
            query += "&repositoryName=" + repositoryName;
        }
        if (repositoryGroupName) {
            query += "&repositoryGroupName=" + repositoryGroupName;
        }
        if (branch) {
            query += "&branch=" + branch;
        }
        if (version) {
            query += "&version=" + version;
        }
        if (user) {
            query += "&user=" + user;
        }
        if (auftrag) {
            query += "&auftrag=" + auftrag;
        }
        if (lowerDate) {
            query += "&lowerDate=" + moment(lowerDate, 'DD.MM.YYYY hh:mm').format("YYYY-MM-DDTHH:mm:ss");
        }
        if (upperDate) {
            query += "&upperDate=" + moment(upperDate, 'DD.MM.YYYY hh:mm').format("YYYY-MM-DDTHH:mm:ss");
        }

        datatable.destroy();
        datatable = $('#resulttable').DataTable( {
            "processing": true,
            "serverSide": true,
            "searching": false,
            "ajax": "api/v1/logs"+query,
            "columns": [
                { "data": "action" },
                { "data": "stage" },
                { "data": "repositoryName" },
                { "data": "repositoryGroupName" },
                { "data": "branch" },
                { "data": "version" },
                { "data": "userId" },
                { "data": "auftragNr" },
                { "data": "logdate" }
            ],
            "columnDefs": [{
                targets: 8,
                render: $.fn.dataTable.render.moment('YYYY-MM-DDTHH:mm:ss','DD.MM.YYYY HH:mm')
            }]
        } );

    }
    function clearFields(event) {
        var $select = $('#action').selectize();
        var control = $select[0].selectize;
        control.clear();
        var $select = $('#stage').selectize();
        var control = $select[0].selectize;
        control.clear();

        $('#stage').val('');
        $('#repositoryName').val('');
        $('#repositoryGroupName').val('');
        $('#branch').val('');
        $('#version').val('');
        $('#user').val('');
        $('#auftrag').val('');
        $('#lowerDate').val('');
        $('#upperDate').val('');
        searchLogs(event);
    }
    function bindevent(){
        $(document).on("click","#searchButton", searchLogs);
        $(document).on("click","#clearButton", clearFields);
        $('.form-control').keypress(function(event){
            if(event.keyCode == 13){
                $('#searchButton').click();
            }
        });
    }
    function initDropdowns() {
        $('#action').selectize({
            preload: true,
            valueField: 'name',
            labelField: 'name',
            sortField: 'name',
            searchField: 'name',
            create: false,
            render: {
                option: function(item, escape) {
                    return '<option value="' + item.name + '">' + item.name + '</option>';
                }
            },
            load: function(query, callback) {
                $.ajax({
                    url: 'api/v1/logs/actions',
                    type: 'GET',
                    dataType: 'json',
                    error: function () {
                        callback();
                    },
                    success: function (res) {
                        callback(res);
                    }
                });
            },
            onChange: function(value) {
                $('#searchButton').click();;
            }
        });
        $('#stage').selectize({
            preload: true,
            valueField: 'name',
            labelField: 'name',
            sortField: 'name',
            searchField: 'name',
            create: false,
            render: {
                option: function(item, escape) {
                    return '<option value="' + item.name + '">' + item.name + '</option>';
                }
            },
            load: function(query, callback) {
                $.ajax({
                    url: 'api/v1/logs/stages',
                    type: 'GET',
                    dataType: 'json',
                    error: function () {
                        callback();
                    },
                    success: function (res) {
                        callback(res);
                    }
                });
            },
            onChange: function(value) {
                $('#searchButton').click();;
            }
        });
    }
</script>
<script type="text/javascript" src="js/app.js"></script>
<script type="text/javascript" src="js/vendor/handlebars.min-6300e57.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/bs/dt-1.10.13/r-2.1.0/datatables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.13/dataRender/datetime.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.45/js/bootstrap-datetimepicker.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.4/js/standalone/selectize.min.js"></script>
<script type="text/javascript" src="js/bootstrap-combobox.js"></script>
</body>
</html>